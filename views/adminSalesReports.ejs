<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Sales Reports</title>
</head>
<body>

  <%- include('partials/adminnavbar') %>

  <div class="container mt-4">
    <div class="row gy-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Revenue (Last 30 days)</h4>
            <p class="text-muted">Total revenue per day. Chart shows trends over time.</p>
            <div style="height:360px;"><canvas id="revenueChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-7">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Top Selling Products</h4>
            <p class="text-muted">Units sold and revenue generated (top 10)</p>
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Product</th>
                    <th>Category</th>
                    <th class="text-end">Units Sold</th>
                    <th class="text-end">Revenue</th>
                    <th class="text-end">% of Total</th>
                  </tr>
                </thead>
                <tbody id="top-products-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-5">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Sales by Categoryyyyyyy</h4>
            <p class="text-muted">Share of revenue by product category</p>
            <div style="height:320px;"><canvas id="categoryChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="col-12 text-end">
        <a href="/admin" class="btn btn-secondary">Back to Dashboard</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const revenue = <%- JSON.stringify(revenue || []) %>;
    const topProducts = <%- JSON.stringify(topProducts || []) %>;
    const categorySales = <%- JSON.stringify(categorySales || []) %>;

    // Revenue chart
    const revLabels = revenue.map(r => r.date);
    const revValues = revenue.map(r => Number(r.revenue) || 0);
    const ctxRev = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRev, {
      type: 'line',
      data: { labels: revLabels, datasets: [{ label: 'Revenue', data: revValues, backgroundColor: 'rgba(40,167,69,0.2)', borderColor: 'rgba(40,167,69,1)', fill: true, tension: 0.2 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Revenue' } }, x: { title: { display: true, text: 'Date' } } }, plugins: { legend: { display: false } } }
    });

    // Top products table and horizontal bar chart data
    const totalRevenue = topProducts.reduce((s, p) => s + (Number(p.revenue) || 0), 0) + categorySales.reduce((s,c)=>s+ (Number(c.revenue)||0),0) - categorySales.reduce((acc,cur)=>acc+0,0); // keep as total fallback
    // Use categorySales sum as authoritative total revenue if available
    const catTotal = categorySales.reduce((s,c) => s + (Number(c.revenue) || 0), 0);
    const authoritativeTotal = catTotal > 0 ? catTotal : totalRevenue || 0;

    const topBody = document.getElementById('top-products-body');
    let idx = 1;
    topProducts.forEach(p => {
      const tr = document.createElement('tr');
      const revenueNum = Number(p.revenue) || 0;
      const pct = authoritativeTotal > 0 ? (revenueNum / authoritativeTotal * 100) : 0;
      tr.innerHTML = `<td>${idx++}</td><td>${p.productName}</td><td>${p.category||''}</td><td class="text-end">${Number(p.unitsSold||0)}</td><td class="text-end">$${revenueNum.toFixed(2)}</td><td class="text-end">${pct.toFixed(1)}%</td>`;
      topBody.appendChild(tr);
    });

    // Category pie chart
    const catLabels = categorySales.map(c => c.categoryName || 'Uncategorized');
    const catValues = categorySales.map(c => Number(c.revenue) || 0);
    const catColors = ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#20c997','#fd7e14','#6610f2'];
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, { type: 'pie', data: { labels: catLabels, datasets: [{ data: catValues, backgroundColor: catLabels.map((_,i)=>catColors[i % catColors.length]) }] }, options: { responsive: true, maintainAspectRatio: false } });
  </script>

</body>
</html>
