<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Bulk Restock</title>
  <style>
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
    .stock-badge.good { background:#28a745; color:#fff; }
    .stock-badge.low { background:#ffae42; color:#000; }
    .stock-badge.out { background:#ff4d4d; color:#fff; }
    .product-image { height:120px; object-fit:cover; width:100%; }
  </style>
</head>
<body>

  <%- include('partials/adminnavbar') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Bulk Restock</h3>
      <div>
        <button id="confirmRestockBtn" class="btn btn-primary" disabled>Confirm Restock</button>
        <a href="/inventory" class="btn btn-secondary ms-2">Back to Inventory</a>
      </div>
    </div>

    <div id="cards" class="card-grid">
      <% products.forEach(p => { %>
        <% 
          let status = 'good';
          if (p.quantity === 0) status = 'out';
          else if (p.quantity <= 20) status = 'low';
        %>

        <div class="card" data-id="<%= p.id %>">
          <img src="/images/<%= p.image %>" class="card-img-top product-image" alt="<%= p.productName %>">
          <div class="card-body">
            <h6 class="card-title"><%= p.productName %></h6>
            <p class="mb-1">Qty: <span class="current-qty"><%= p.quantity %></span></p>
            <span class="badge stock-badge <%= status %>">
              <%= status === 'out' ? 'Out of stock' : (status === 'low' ? 'Low' : 'Good') %>
            </span>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              <button class="btn btn-sm btn-outline-primary select-btn">Select</button>
            </div>
            <div>
              <input type="checkbox" class="select-checkbox form-check-input">
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Restock</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>You are restocking for these products:</p>
            <ul id="selectedList"></ul>

            <div class="mb-3">
              <label for="restockAmountInput" class="form-label">Quantity to restock:</label>
              <input id="restockAmountInput" type="number" class="form-control" min="1" value="1">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="doRestockBtn" type="button" class="btn btn-primary">Confirm</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const cardContainer = document.getElementById('cards');
    const confirmBtn = document.getElementById('confirmRestockBtn');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const selectedList = document.getElementById('selectedList');
    const restockAmountInput = document.getElementById('restockAmountInput');
    const doRestockBtn = document.getElementById('doRestockBtn');

    function updateConfirmState() {
      const any = document.querySelectorAll('.select-checkbox:checked').length > 0;
      confirmBtn.disabled = !any;
    }

    // Toggle card checkbox when select button clicked
    cardContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('select-btn')) {
        const card = e.target.closest('.card');
        const cb = card.querySelector('.select-checkbox');
        cb.checked = !cb.checked;
        e.target.classList.toggle('active', cb.checked);
        updateConfirmState();
      }
    });

    cardContainer.addEventListener('change', (e) => {
      if (e.target.classList.contains('select-checkbox')) updateConfirmState();
    });

    confirmBtn.addEventListener('click', () => {
      // build list
      const checked = Array.from(document.querySelectorAll('.select-checkbox:checked'));
      selectedList.innerHTML = '';
      checked.forEach(cb => {
        const card = cb.closest('.card');
        const id = card.getAttribute('data-id');
        const name = card.querySelector('.card-title')?.innerText || card.querySelector('h6')?.innerText;
        const li = document.createElement('li');
        li.dataset.id = id;
        li.innerText = name + ' (current: ' + card.querySelector('.current-qty').innerText + ')';
        selectedList.appendChild(li);
      });
      confirmModal.show();
    });

    doRestockBtn.addEventListener('click', async () => {
      const amount = parseInt(restockAmountInput.value);
      if (!amount || amount < 1) return alert('Enter a valid restock quantity');

      const ids = Array.from(document.querySelectorAll('.select-checkbox:checked')).map(cb => cb.closest('.card').getAttribute('data-id'));

      try {
        const res = await fetch('/inventory/bulk-restock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids, amount })
        });
        const data = await res.json();
        if (!data.success) return alert('Error: ' + data.message);

        // Update UI: increment quantities and badges
        ids.forEach(id => {
          const card = document.querySelector('.card[data-id="' + id + '"]');
          const qtyEl = card.querySelector('.current-qty');
          const newQty = parseInt(qtyEl.innerText) + amount;
          qtyEl.innerText = newQty;

          const badge = card.querySelector('.stock-badge');
          if (newQty === 0) { badge.className = 'badge stock-badge out'; badge.innerText = 'Out of stock'; }
          else if (newQty <= 20) { badge.className = 'badge stock-badge low'; badge.innerText = 'Low'; }
          else { badge.className = 'badge stock-badge good'; badge.innerText = 'Good'; }
        });

        confirmModal.hide();
        alert('Restock successful!');
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    });

  </script>

</body>
</html>
